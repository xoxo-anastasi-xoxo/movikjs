var MovikJS=function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";var i,o,r,s,a;n.r(e),function(t){t[t.NONE=0]="NONE",t[t.GLOBAL_ROTOR=1]="GLOBAL_ROTOR",t[t.LOCAL_ROTOR=2]="LOCAL_ROTOR",t[t.GLOBAL_HINGE=3]="GLOBAL_HINGE",t[t.LOCAL_HINGE=4]="LOCAL_HINGE"}(i||(i={})),function(t){t[t.NONE=0]="NONE",t[t.GLOBAL_ABSOLUTE=1]="GLOBAL_ABSOLUTE",t[t.LOCAL_RELATIVE=2]="LOCAL_RELATIVE",t[t.LOCAL_ABSOLUTE=3]="LOCAL_ABSOLUTE"}(o||(o={})),function(t){t[t.BALL=0]="BALL",t[t.GLOBAL_HINGE=1]="GLOBAL_HINGE",t[t.LOCAL_HINGE=2]="LOCAL_HINGE"}(r||(r={})),function(t){t[t.START=0]="START",t[t.END=1]="END"}(s||(s={})),function(t){t[t.LOCAL=0]="LOCAL",t[t.GLOBAL=1]="GLOBAL"}(a||(a={}));var h=function(){function t(e,n,i){var o=this;switch(this._clockwiseConstraintDegs=t.MAX_2D_CONSTRAINT_ANGLE_DEGS,this._anticlockwiseConstraintDegs=t.MAX_2D_CONSTRAINT_ANGLE_DEGS,this._constraintCoordinateSystem=a.LOCAL,this.getClockwiseConstraintDegs=function(){return o._clockwiseConstraintDegs},this.getAnticlockwiseConstraintDegs=function(){return o._anticlockwiseConstraintDegs},this.setConstraintCoordinateSystem=function(t){o._constraintCoordinateSystem=t},this.getConstraintCoordinateSystem=function(){return o._constraintCoordinateSystem},arguments.length){case 0:return;case 3:return this.setClockwiseConstraintDegs(e),this.setAnticlockwiseConstraintDegs(n),void(this._constraintCoordinateSystem=i);default:throw Error("Invalid FabrikJoint2D constructor params!")}}return t.prototype.set=function(t){this.setClockwiseConstraintDegs(t._clockwiseConstraintDegs),this.setAnticlockwiseConstraintDegs(t._anticlockwiseConstraintDegs),this._constraintCoordinateSystem=t._constraintCoordinateSystem},t.prototype.setClockwiseConstraintDegs=function(e){e<t.MIN_2D_CONSTRAINT_ANGLE_DEGS?this._clockwiseConstraintDegs=t.MIN_2D_CONSTRAINT_ANGLE_DEGS:e>t.MAX_2D_CONSTRAINT_ANGLE_DEGS?this._clockwiseConstraintDegs=t.MAX_2D_CONSTRAINT_ANGLE_DEGS:this._clockwiseConstraintDegs=e},t.prototype.setAnticlockwiseConstraintDegs=function(e){e<t.MIN_2D_CONSTRAINT_ANGLE_DEGS?this._anticlockwiseConstraintDegs=t.MIN_2D_CONSTRAINT_ANGLE_DEGS:e>t.MAX_2D_CONSTRAINT_ANGLE_DEGS?this._anticlockwiseConstraintDegs=t.MAX_2D_CONSTRAINT_ANGLE_DEGS:this._anticlockwiseConstraintDegs=e},t.MIN_2D_CONSTRAINT_ANGLE_DEGS=0,t.MAX_2D_CONSTRAINT_ANGLE_DEGS=180,t}(),c=function(){function t(e){var n=this;switch(this.r=1,this.g=1,this.b=1,this.a=1,this.toArray=function(){return[n.r,n.g,n.b,n.a]},arguments.length){case 0:break;case 1:if(!(e instanceof Array&&4==e.length))throw new Error("Colour source array size must be precisely 4 elements.");this.r=t._clamp(e[0]),this.g=t._clamp(e[1]),this.b=t._clamp(e[2]),this.a=t._clamp(e[3]);break;default:throw new Error("Colour constructor was invoked incorrectly.")}}return t.prototype.set=function(e){this.r=t._clamp(e[0]),this.g=t._clamp(e[1]),this.b=t._clamp(e[2]),this.a=t._clamp(e[3])},t.prototype.addRGB=function(e,n,i){return this.r=t._clamp(this.r+e),this.g=t._clamp(this.g+n),this.b=t._clamp(this.b+i),this},t.prototype.subtractRGB=function(e,n,i){return this.r=t._clamp(this.r-e),this.g=t._clamp(this.g-n),this.b=t._clamp(this.b-i),this},t.prototype.lighten=function(t){return this.addRGB(t,t,t)},t.prototype.darken=function(t){return this.subtractRGB(t,t,t)},t._clamp=function(e){return e>t.MAX_COMPONENT_VALUE?t.MAX_COMPONENT_VALUE:e<t.MIN_COMPONENT_VALUE?t.MIN_COMPONENT_VALUE:e},t.MIN_COMPONENT_VALUE=0,t.MAX_COMPONENT_VALUE=1,t}(),u=function(){function t(){}return t.sign=function(t){return t>=0?1:-1},t.validateDirectionUV=function(t){if(t.length()<=0)throw new Error("Vec direction unit vector cannot be zero.")},t.validateLength=function(t){if(t<0)throw new Error("Length must be a greater than or equal to zero.")},t.DEGS_TO_RADS=Math.PI/180,t.RADS_TO_DEGS=180/Math.PI,t.formatter=function(t){return t.toFixed(3)},t.RED=new c([1,0,0,1]),t.GREEN=new c([0,1,0,1]),t.BLUE=new c([0,0,1,1]),t.MID_RED=new c([.6,0,0,1]),t.MID_GREEN=new c([0,.6,0,1]),t.MID_BLUE=new c([0,0,.6,1]),t.BLACK=new c([0,0,0,1]),t.GREY=new c([.5,.5,.5,1]),t.WHITE=new c([1,1,1,1]),t.YELLOW=new c([1,1,0,1]),t.CYAN=new c([0,1,1,1]),t.MAGENTA=new c([1,0,1,1]),t.cot=function(t){return 1/Math.tan(t)},t.radiansToDegrees=function(e){return e*t.RADS_TO_DEGS},t.degreesToRadians=function(e){return e*t.DEGS_TO_RADS},t.approximatelyEquals=function(t,e,n){return Math.abs(t-e)<=n},t}(),g=function(){function t(t,e,n,i,o,r,s,a,h){var c=this;switch(this.m00=0,this.m01=0,this.m02=0,this.m10=0,this.m11=0,this.m12=0,this.m20=0,this.m21=0,this.m22=0,this.rotateDegs=function(t,e){return c.rotateRads(e,t*u.DEGS_TO_RADS)},this.getXBasis=function(){return new l(c.m00,c.m01,c.m02)},this.getYBasis=function(){return new l(c.m10,c.m11,c.m12)},this.getZBasis=function(){return new l(c.m20,c.m21,c.m22)},this.toArray=function(){return[c.m00,c.m01,c.m02,c.m10,c.m11,c.m12,c.m20,c.m21,c.m22]},arguments.length){case 0:return;case 9:return this.m00=t,this.m01=e,this.m02=n,this.m10=i,this.m11=o,this.m12=r,this.m20=s,this.m21=a,void(this.m22=h);default:throw Error("Invalid Mat3f constructor params.")}}return t.prototype.zero=function(){this.m00=this.m01=this.m02=this.m10=this.m11=this.m12=this.m20=this.m21=this.m22=0},t.prototype.setIdentity=function(){this.m00=this.m11=this.m22=1,this.m01=this.m02=this.m10=this.m12=this.m20=this.m21=0},t.createRotationMatrix=function(e){var n=new t;return 1==e.y&&(e.y-=1e-4,e.normalise()),n.setZBasis(e),n.setXBasis(l.crossProduct(e,new l(0,1,0)).normalised()),n.setYBasis(l.crossProduct(n.getXBasis(),n.getZBasis()).normalised()),n},t.prototype.isOrthogonal=function(){var t=l.dotProduct(this.getXBasis(),this.getYBasis()),e=l.dotProduct(this.getXBasis(),this.getZBasis()),n=l.dotProduct(this.getYBasis(),this.getZBasis());return u.approximatelyEquals(t,0,.01)&&u.approximatelyEquals(e,0,.01)&&u.approximatelyEquals(n,0,.01)},t.prototype.times=function(t){return new l(this.m00*t.x+this.m10*t.y+this.m20*t.z,this.m01*t.x+this.m11*t.y+this.m21*t.z,this.m02*t.x+this.m12*t.y+this.m22*t.z)},t.prototype.determinant=function(){return this.m20*this.m01*this.m12-this.m20*this.m02*this.m11-this.m10*this.m01*this.m22+this.m10*this.m02*this.m21+this.m00*this.m11*this.m22-this.m00*this.m12*this.m21},t.inverse=function(e){var n=e.determinant(),i=new t;return i.m00=(e.m11*e.m22-e.m12*e.m21)/n,i.m01=-(e.m01*e.m22-e.m02*e.m21)/n,i.m02=(e.m01*e.m12-e.m02*e.m11)/n,i.m10=-(-e.m20*e.m12+e.m10*e.m22)/n,i.m11=(-e.m20*e.m02+e.m00*e.m22)/n,i.m12=-(-e.m10*e.m02+e.m00*e.m12)/n,i.m20=(-e.m20*e.m11+e.m10*e.m21)/n,i.m21=-(-e.m20*e.m01+e.m00*e.m21)/n,i.m22=(-e.m10*e.m02+e.m00*e.m11)/n,i},t.prototype.rotateRads=function(e,n){var i=new t,o=Math.sin(n),r=Math.cos(n),s=1-r,a=e.x*e.y,h=e.y*e.z,c=e.x*e.z,u=e.x*o,g=e.y*o,l=e.z*o,d=e.x*e.x*s+r,p=a*s+l,_=c*s-g,f=a*s-l,m=e.y*e.y*s+r,L=h*s+u,y=c*s+g,C=h*s-u,A=e.z*e.z*s+r,b=this.m00*d+this.m10*p+this.m20*_,v=this.m01*d+this.m11*p+this.m21*_,w=this.m02*d+this.m12*p+this.m22*_,E=this.m00*f+this.m10*m+this.m20*L,x=this.m01*f+this.m11*m+this.m21*L,D=this.m02*f+this.m12*m+this.m22*L;return i.m20=this.m00*y+this.m10*C+this.m20*A,i.m21=this.m01*y+this.m11*C+this.m21*A,i.m22=this.m02*y+this.m12*C+this.m22*A,i.m00=b,i.m01=v,i.m02=w,i.m10=E,i.m11=x,i.m12=D,i},t.prototype.setXBasis=function(t){this.m00=t.x,this.m01=t.y,this.m02=t.z},t.prototype.setYBasis=function(t){this.m10=t.x,this.m11=t.y,this.m12=t.z},t.prototype.setZBasis=function(t){this.m20=t.x,this.m21=t.y,this.m22=t.z},t.identity=function(){var t=new Float32Array(9);return t[0]=t[4]=t[8]=1,t},t.transpose=function(e){return new t(e.m00,e.m10,e.m20,e.m01,e.m11,e.m21,e.m02,e.m12,e.m22)},t}(),l=function(){function t(e,n,i){var o=this;switch(this.x=0,this.y=0,this.z=0,this.negated=function(){return new t(-o.x,-o.y,-o.z)},this.cross=function(e){return new t(o.y*e.z-o.z*e.y,o.z*e.x-o.x*e.z,o.x*e.y-o.y*e.x)},this.length=function(){return Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z)},this.plus=function(e){return new t(o.x+e.x,o.y+e.y,o.z+e.z)},this.minus=function(e){return new t(o.x-e.x,o.y-e.y,o.z-e.z)},this.toArray=function(){return[o.x,o.y,o.z]},arguments.length){case 0:break;case 1:e instanceof t?(this.x=e.x,this.y=e.y,this.z=e.z):this.x=this.y=this.z=e;break;case 3:if("number"!=typeof e)throw new Error("Vec3f constructor was invoked incorrectly.");this.x=e,this.y=n,this.z=i}}return t.prototype.set=function(e,n,i){switch(arguments.length){case 0:break;case 1:if(!(e instanceof t))throw new Error("Vec3f set was invoked incorrectly.");this.x=e.x,this.y=e.y,this.z=e.z;break;case 3:if("number"!=typeof e)throw new Error("Vec3f set was invoked incorrectly.");this.x=e,this.y=n,this.z=i;break;default:throw new Error("Vec3f set was invoked incorrectly.")}},t.prototype.approximatelyEquals=function(t,e){if(e<0)throw Error("Equality threshold must be greater than or equal to 0.0f");var n=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y),o=Math.abs(this.z-t.z);return n<e&&i<e&&o<e},t.prototype.lengthIsApproximately=function(t,e){if(e<0)throw new Error("Comparison tolerance cannot be less than zero.");return Math.abs(this.length()-t)<e},t.prototype.zero=function(){this.x=this.y=this.z=0},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.normalise=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return t>0&&(this.x/=t,this.y/=t,this.z/=t),this},t.prototype.normalised=function(){return new t(this).normalise()},t.dotProduct=function(t,e){var n=t.normalised(),i=e.normalised();return n.x*i.x+n.y*i.y+n.z*i.z},t.distanceBetween=function(t,e){var n=e.x-t.x,i=e.y-t.y,o=e.z-t.z;return Math.sqrt(n*n+i*i+o*o)},t.abs=function(e){var n=new t;return e.x<0?n.x=-e.x:n.x=e.x,e.y<0?n.y=-e.y:n.y=e.y,e.z<0?n.z=-e.z:n.z=e.z,n},t.genPerpendicularVectorQuick=function(e){return(Math.abs(e.y)<.99?new t(-e.z,0,e.x):new t(0,e.z,-e.y)).normalise()},t.getAngleBetweenRads=function(e,n){return Math.acos(t.dotProduct(e,n))},t.getAngleBetweenDegs=function(e,n){return t.getAngleBetweenRads(e,n)*u.RADS_TO_DEGS},t.getSignedAngleBetweenDegs=function(e,n,i){return t.getAngleBetweenDegs(e,n)*u.sign(t.dotProduct(t.crossProduct(e,n),i))},t.getAngleLimitedUnitVectorDegs=function(e,n,i){if(t.getAngleBetweenDegs(n,e)>i){var o=t.crossProduct(n.normalised(),e.normalised()).normalise();return t.rotateAboutAxisDegs(n,i,o).normalised()}return e.normalised()},t.prototype.getGlobalPitchDegs=function(){var e=this.projectOntoPlane(t.X_AXIS),n=t.getAngleBetweenDegs(t.Z_AXIS.negated(),e);return e.y<0?-n:n},t.prototype.getGlobalYawDegs=function(){var e=this.projectOntoPlane(t.Y_AXIS),n=t.getAngleBetweenDegs(t.Z_AXIS.negated(),e);return e.x<0?-n:n},t.rotateXRads=function(e,n){var i=Math.cos(n),o=Math.sin(n);return new t(e.x,e.y*i-e.z*o,e.y*o+e.z*i)},t.rotateXDegs=function(e,n){return t.rotateXRads(e,n*u.DEGS_TO_RADS)},t.rotateYRads=function(e,n){var i=Math.cos(n),o=Math.sin(n);return new t(e.z*o+e.x*i,e.y,e.z*i-e.x*o)},t.rotateYDegs=function(e,n){return t.rotateYRads(e,n*u.DEGS_TO_RADS)},t.rotateZRads=function(e,n){var i=Math.cos(n),o=Math.sin(n);return new t(e.x*i-e.y*o,e.x*o+e.y*i,e.z)},t.rotateZDegs=function(e,n){return t.rotateZRads(e,n*u.DEGS_TO_RADS)},t.rotateAboutAxisRads=function(t,e,n){var i=new g,o=Math.sin(e),r=Math.cos(e),s=1-r,a=n.x*n.y*s,h=n.x*n.z*s,c=n.y*n.z*s;return i.m00=n.x*n.x*s+r,i.m01=a+n.z*o,i.m02=h-n.y*o,i.m10=a-n.z*o,i.m11=n.y*n.y*s+r,i.m12=c+n.x*o,i.m20=h+n.y*o,i.m21=c-n.x*o,i.m22=n.z*n.z*s+r,i.times(t)},t.rotateAboutAxisDegs=function(e,n,i){return t.rotateAboutAxisRads(e,n*u.DEGS_TO_RADS,i)},t.prototype.times=function(e){return e instanceof t?new t(this.x*e.x,this.y*e.y,this.z*e.z):new t(this.x*e,this.y*e,this.z*e)},t.times=function(t,e){t.x*=e,t.y*=e,t.z*=e},t.add=function(t,e){t.x+=e.x,t.y+=e.y,t.z+=e.z},t.subtract=function(t,e){t.x-=e.x,t.y-=e.y,t.z-=e.z},t.prototype.dividedBy=function(e){return new t(this.x/e,this.y/e,this.z/e)},t.prototype.projectOntoPlane=function(e){if(!(e.length()>0))throw new Error("Plane normal cannot be a zero vector.");var n=this.normalised(),i=e.normalised();return n.minus(i.times(t.dotProduct(n,e))).normalise()},t.getDirectionUV=function(t,e){return e.minus(t).normalise()},t.X_AXIS=new t(1,0,0),t.Y_AXIS=new t(0,1,0),t.Z_AXIS=new t(0,0,1),t.clone=function(e){return new t(e.x,e.y,e.z)},t.perpendicular=function(e,n){return u.approximatelyEquals(t.dotProduct(e,n),0,.01)},t.approximatelyEqual=function(t,e,n){return Math.abs(t.x-e.x)<n&&Math.abs(t.y-e.y)<n&&Math.abs(t.z-e.z)<n},t.scalarProduct=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},t.crossProduct=function(e,n){return new t(e.y*n.z-e.z*n.y,e.z*n.x-e.x*n.z,e.x*n.y-e.y*n.x)},t.getUvBetween=function(e,n){return new t(n.minus(e)).normalise()},t}(),d=function(){function t(e){this._rotorConstraintDegs=t.MAX_CONSTRAINT_ANGLE_DEGS,this._hingeClockwiseConstraintDegs=t.MAX_CONSTRAINT_ANGLE_DEGS,this._hingeAnticlockwiseConstraintDegs=t.MAX_CONSTRAINT_ANGLE_DEGS,this._rotationAxisUV=new l,this._referenceAxisUV=new l,this._jointType=r.BALL,e&&this.set(e)}return t.prototype.set=function(t){this._jointType=t._jointType,this._rotorConstraintDegs=t._rotorConstraintDegs,this._hingeClockwiseConstraintDegs=t._hingeClockwiseConstraintDegs,this._hingeAnticlockwiseConstraintDegs=t._hingeAnticlockwiseConstraintDegs,this._rotationAxisUV.set(t._rotationAxisUV),this._referenceAxisUV.set(t._referenceAxisUV)},t.prototype.setAsBallJoint=function(e){t._validateConstraintAngleDegs(e),this._rotorConstraintDegs=e,this._jointType=r.BALL},t.prototype.setHingeJoint=function(e,n,i,o,r){if(!u.approximatelyEquals(l.dotProduct(n,r),0,.01)){var s=l.getAngleBetweenDegs(n,r);throw new Error("The reference axis must be in the plane of the hinge rotation axis - angle between them is currently: "+s)}t._validateConstraintAngleDegs(i),t._validateConstraintAngleDegs(o),t._validateAxis(n),t._validateAxis(r),this._hingeClockwiseConstraintDegs=i,this._hingeAnticlockwiseConstraintDegs=o,this._jointType=e,this._rotationAxisUV.set(n.normalised()),this._referenceAxisUV.set(r.normalised())},t.prototype.setHingeJointClockwiseConstraintDegs=function(e){if(t._validateConstraintAngleDegs(e),this._jointType===r.BALL)throw new Error("Joint type is JointType.BALL - it does not have hinge constraint angles.");this._hingeClockwiseConstraintDegs=e},t.prototype.getHingeClockwiseConstraintDegs=function(){if(this._jointType!==r.BALL)return this._hingeClockwiseConstraintDegs;throw new Error("Joint type is JointType.BALL - it does not have hinge constraint angles.")},t.prototype.setHingeJointAnticlockwiseConstraintDegs=function(e){if(t._validateConstraintAngleDegs(e),this._jointType===r.BALL)throw new Error("Joint type is JointType.BALL - it does not have hinge constraint angles.");this._hingeAnticlockwiseConstraintDegs=e},t.prototype.getHingeAnticlockwiseConstraintDegs=function(){if(this._jointType!==r.BALL)return this._hingeAnticlockwiseConstraintDegs;throw new Error("Joint type is JointType.BALL - it does not have hinge constraint angles.")},t.prototype.setBallJointConstraintDegs=function(e){if(t._validateConstraintAngleDegs(e),this._jointType!==r.BALL)throw new Error("This joint is of type: "+this._jointType+" - only joints of type JointType.BALL have a ball joint constraint angle.");this._rotorConstraintDegs=e},t.prototype.getBallJointConstraintDegs=function(){if(this._jointType===r.BALL)return this._rotorConstraintDegs;throw new Error("This joint is not of type JointType.BALL - it does not have a ball joint constraint angle.")},t.prototype.setHingeRotationAxis=function(e){if(t._validateAxis(e),this._jointType===r.BALL)throw new Error("Joint type is JointType.BALL - it does not have a hinge rotation axis.");this._rotationAxisUV.set(e.normalised())},t.prototype.getHingeReferenceAxis=function(){if(this._jointType!==r.BALL)return this._referenceAxisUV;throw new Error("Joint type is JointType.BALL - it does not have a hinge reference axis.")},t.prototype.setHingeReferenceAxis=function(e){if(t._validateAxis(e),this._jointType===r.BALL)throw new Error("Joint type is JointType.BALL - it does not have a hinge reference axis.");this._referenceAxisUV.set(e.normalised())},t.prototype.getHingeRotationAxis=function(){if(this._jointType!==r.BALL)return this._rotationAxisUV;throw new Error("Joint type is JointType.BALL - it does not have a hinge rotation axis.")},t.prototype.getJointType=function(){return this._jointType},t._validateConstraintAngleDegs=function(e){if(e<t.MIN_CONSTRAINT_ANGLE_DEGS||e>t.MAX_CONSTRAINT_ANGLE_DEGS)throw new Error("Constraint angles must be within the range "+t.MIN_CONSTRAINT_ANGLE_DEGS+" to "+t.MAX_CONSTRAINT_ANGLE_DEGS+" inclusive.")},t._validateAxis=function(t){if(t.length()<=0)throw new Error("Provided axis is illegal - it has a magnitude of zero.")},t.MIN_CONSTRAINT_ANGLE_DEGS=0,t.MAX_CONSTRAINT_ANGLE_DEGS=180,t}(),p=function(){function t(e,n){var i=this;switch(this.x=0,this.y=0,this.plus=function(e){return new t(i.x+e.x,i.y+e.y)},this.minus=function(e){return new t(i.x-e.x,i.y-e.y)},this.times=function(e){return new t(i.x*e,i.y*e)},this.dividedBy=function(e){return new t(i.x/e,i.y/e)},this.negated=function(){return new t(-i.x,-i.y)},this.length=function(){return Math.sqrt(i.x*i.x+i.y*i.y)},this.dot=function(t){return i.x*t.x+i.y*t.y},this.toArray=function(){return[i.x,i.y]},arguments.length){case 0:return;case 1:if(e instanceof t)return this.x=e.x,void(this.y=e.y);throw new Error("Wrong Vec2f constructor params!");case 2:if("number"==typeof e)return this.x=e,void(this.y=n);throw new Error("Wrong Vec2f constructor params!")}}return t.prototype.approximatelyEquals=function(t,e){if(e<0)throw new Error("Equality threshold must be greater than or equal to 0.0");return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e},t.prototype.set=function(e,n){switch(arguments.length){case 1:if(e instanceof t)return this.x=e.x,void(this.y=e.y);throw new Error("Wrong Vec2f set params!");case 2:if("number"==typeof e)return this.x=e,void(this.y=n);throw new Error("Wrong Vec2f set params!");default:throw new Error("Wrong Vec2f set params!")}},t.prototype.normalise=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);return t>0&&(this.x/=t,this.y/=t),this},t.normalised=function(e){return new t(e).normalise()},t.zcross=function(t,e){var n=t.x*e.y-e.x*t.y;return n>0?1:n<0?-1:0},t.prototype.getSignedAngleDegsTo=function(e){var n=t.normalised(this),i=t.normalised(e),o=Math.acos(n.dot(i))*u.RADS_TO_DEGS;return 1==t.zcross(n,i)?o:-o},t.getConstrainedUV=function(e,n,i,o){var r=n.getSignedAngleDegsTo(e);return r>o?t.rotateDegs(n,o):r<-i?t.rotateDegs(n,-i):e},t.prototype.rotateRads=function(e){var n=Math.cos(e),i=Math.sin(e),o=new t(this.x*n-this.y*i,this.x*i+this.y*n);return this.x=o.x,this.y=o.y,this},t.rotateDegs=function(e,n){var i=n*u.DEGS_TO_RADS,o=Math.cos(i),r=Math.sin(i);return new t(e.x*o-e.y*r,e.x*r+e.y*o)},t.getDirectionUV=function(t,e){return e.minus(t).normalise()},t.distanceBetween=function(t,e){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))},t.dot=function(t,e){return t.x*e.x+t.y*e.y},t.getUnsignedAngleBetweenVectorsDegs=function(e,n){return Math.acos(t.normalised(e).dot(t.normalised(n)))*u.RADS_TO_DEGS},t}(),_=function(){function t(t,e,n,i,o,r,s){var a=this;switch(this._joint=new h,this._startLocation=new p,this._endLocation=new p,this._name="",this._globalConstraintUV=new p(1,0),this._colour=new c,this.getGlobalConstraintUV=function(){return a._globalConstraintUV},this.getLength=function(){return a._length},this.getColour=function(){return a._colour},this.getStartLocation=function(){return a._startLocation},this.getStartLocationAsArray=function(){return[a._startLocation.x,a._startLocation.y]},this.getEndLocation=function(){return a._endLocation},this.getEndLocationAsArray=function(){return[a._endLocation.x,a._endLocation.y]},this.getJoint=function(){return a._joint},this.getClockwiseConstraintDegs=function(){return a._joint.getClockwiseConstraintDegs()},this.getDirectionUV=function(){return p.getDirectionUV(a._startLocation,a._endLocation)},this.getName=function(){return a._name},this.getJointConstraintCoordinateSystem=function(){return a._joint.getConstraintCoordinateSystem()},arguments.length){case 0:break;case 1:throw new Error("FabrikBone2D constructor can not have 1 param.");default:if(!t||!e)throw new Error("Invalid FabrikBone2D constructor params.");null==n?(this._startLocation.set(t),this._endLocation.set(e),this._updateLength()):(u.validateDirectionUV(e),this._startLocation.set(t),this._endLocation.set(this._startLocation.plus(p.normalised(e).times(n))),this._updateLength()),"number"==typeof i&&this.setClockwiseConstraintDegs(i),"number"==typeof o&&this.setAnticlockwiseConstraintDegs(o),r instanceof c&&this._colour.set(r.toArray()),"string"==typeof s&&(this._name=s)}}return t.prototype.set=function(t){this._startLocation.set(t._startLocation),this._endLocation.set(t._endLocation),this._joint.set(t._joint),this._colour.set(t._colour.toArray()),this._name=t._name,this._length=t._length,this._globalConstraintUV=t._globalConstraintUV},t.prototype.setColour=function(t){this._colour.set(t.toArray())},t.prototype.setStartLocation=function(t){this._startLocation.set(t)},t.prototype.setEndLocation=function(t){this._endLocation.set(t)},t.prototype.setJoint=function(t){this._joint.set(t)},t.prototype.setClockwiseConstraintDegs=function(t){this._joint.setClockwiseConstraintDegs(t)},t.prototype.setAnticlockwiseConstraintDegs=function(t){this._joint.setAnticlockwiseConstraintDegs(t)},t.prototype.getAnticlockwiseConstraintDegs=function(){return this._joint.getAnticlockwiseConstraintDegs()},t.prototype.setName=function(t){this._name=t},t.prototype.setJointConstraintCoordinateSystem=function(t){this._joint.setConstraintCoordinateSystem(t)},t.prototype._updateLength=function(){var t=p.distanceBetween(this._startLocation,this._endLocation);if(!(t>=0))throw new Error("Bone getLength must be a positive value.");this._length=t},t}(),f=function(){function t(t,e,n,i,o){var r=this;switch(this._boneConnectionPoint=s.END,this._joint=new d,this._startLocation=new l,this._endLocation=new l,this._name="",this._length=0,this._colour=new c,this.getLength=function(){return r._length},this.getLifeLength=function(){return l.distanceBetween(r._startLocation,r._endLocation)},this.getBoneConnectionPoint=function(){return r._boneConnectionPoint},this.getColour=function(){return r._colour},this.getStartLocation=function(){return r._startLocation},this.getStartLocationAsArray=function(){return[r._startLocation.x,r._startLocation.y,r._startLocation.z]},this.getEndLocation=function(){return r._endLocation},this.getEndLocationAsArray=function(){return[r._endLocation.x,r._endLocation.y,r._endLocation.z]},this.getJoint=function(){return r._joint},this.getJointType=function(){return r._joint.getJointType()},this.getName=function(){return r._name},arguments.length){case 0:break;case 1:throw new Error("FabrikBone2D constructor can not have 1 param.");default:if(!t||!e)throw new Error("Invalid FabrikBone2D constructor params.");null==n?(this._startLocation.set(t),this._endLocation.set(e),this._updateLength()):(u.validateDirectionUV(e),this._startLocation.set(t),this._endLocation.set(this._startLocation.plus(e.normalised().times(n))),this._updateLength()),i instanceof c&&this._colour.set(i.toArray()),"string"==typeof o&&(this._name=o)}}return t.prototype.set=function(t){this._startLocation.set(t._startLocation),this._endLocation.set(t._endLocation),this._joint.set(t._joint),this._colour.set(t._colour.toArray()),this._name=t._name,this._length=t._length,this._boneConnectionPoint=t._boneConnectionPoint},t.prototype.setBoneConnectionPoint=function(t){this._boneConnectionPoint=t},t.prototype.setColour=function(t){this._colour.set(t.toArray())},t.prototype.setJoint=function(t){this._joint.set(t)},t.prototype.setHingeJointClockwiseConstraintDegs=function(t){this._joint.setHingeJointClockwiseConstraintDegs(t)},t.prototype.getHingeJointClockwiseConstraintDegs=function(){return this._joint.getHingeClockwiseConstraintDegs()},t.prototype.setHingeJointAnticlockwiseConstraintDegs=function(t){this._joint.setHingeJointAnticlockwiseConstraintDegs(t)},t.prototype.getHingeJointAnticlockwiseConstraintDegs=function(){return this._joint.getHingeAnticlockwiseConstraintDegs()},t.prototype.setBallJointConstraintDegs=function(t){this._joint.setBallJointConstraintDegs(t)},t.prototype.getBallJointConstraintDegs=function(){return this._joint.getBallJointConstraintDegs()},t.prototype.getDirectionUV=function(){return l.getDirectionUV(this._startLocation,this._endLocation)},t.prototype.getGlobalPitchDegs=function(){return l.getDirectionUV(this._startLocation,this._endLocation).getGlobalPitchDegs()},t.prototype.getGlobalYawDegs=function(){return l.getDirectionUV(this._startLocation,this._endLocation).getGlobalYawDegs()},t.prototype.setName=function(t){this._name=t},t.prototype.setStartLocation=function(t){this._startLocation.set(t)},t.prototype.setEndLocation=function(t){this._endLocation.set(t)},t.prototype._updateLength=function(){var t=l.distanceBetween(this._startLocation,this._endLocation);if(!(t>=0))throw new Error("Bone getLength must be a positive value.");this._length=t},t}(),m=function(){function t(t){this._chain=[],this._name="",this._solveDistanceThreshold=1,this._maxIterationAttempts=15,this._minIterationChange=.01,this._chainLength=0,this._baseLocation=new p,this._fixedBaseMode=!0,this._baseboneConstraintType=o.NONE,this._boneConnectionPoint=s.END,this._baseboneConstraintUV=new p,this._baseboneRelativeConstraintUV=new p,this._lastTargetLocation=new p(Number.MAX_VALUE,Number.MAX_VALUE),this._lastBaseLocation=new p(Number.MAX_VALUE,Number.MAX_VALUE),this._embeddedTarget=new p,this._useEmbeddedTarget=!1,this._currentSolveDistance=Number.MAX_VALUE,this._connectedChainNumber=-1,this._connectedBoneNumber=-1,t&&("string"==typeof t?this._name=t:(this._chain=t.cloneChainVector(),this._baseLocation.set(t._baseLocation),this._lastTargetLocation.set(t._lastTargetLocation),this._lastBaseLocation.set(t._lastBaseLocation),this._baseboneConstraintUV.set(t._baseboneConstraintUV),this._baseboneRelativeConstraintUV.set(t._baseboneRelativeConstraintUV),this._embeddedTarget.set(t._embeddedTarget),this._chainLength=t._chainLength,this._currentSolveDistance=t._currentSolveDistance,this._connectedChainNumber=t._connectedChainNumber,this._connectedBoneNumber=t._connectedBoneNumber,this._baseboneConstraintType=t._baseboneConstraintType,this._boneConnectionPoint=t._boneConnectionPoint,this._name=t._name,this._useEmbeddedTarget=t._useEmbeddedTarget))}return t.prototype.addBone=function(t){this._chain.push(t),1===this._chain.length&&(this._baseLocation.set(t.getStartLocation()),this._baseboneConstraintUV=t.getDirectionUV()),this.updateChainLength()},t.prototype.addConsecutiveConstrainedBone=function(t,e,n,i,o){if(void 0===o&&(o=new c),u.validateDirectionUV(t),u.validateLength(e),0===this._chain.length)throw new Error("You cannot add the base bone to a chain using this method as it does not provide a start location.");var r=this._chain[this._chain.length-1].getEndLocation(),s=new _(r,p.normalised(t),e,n,i,o);this.addBone(s)},t.prototype.addConsecutiveBone=function(t,e){this.addConsecutiveConstrainedBone(t,e,180,180,new c)},t.prototype.addConsecutiveCreatedBone=function(t){var e=t.getDirectionUV();u.validateDirectionUV(e);var n=t.getLength();if(u.validateLength(n),0===this._chain.length)throw new Error("You cannot add the base bone to a chain using this method as it does not provide a start location.");var i=this._chain[this._chain.length-1].getEndLocation();t.setStartLocation(i),t.setEndLocation(i.plus(e.times(n))),this.addBone(t)},t.prototype.getBaseboneConstraintType=function(){return this._baseboneConstraintType},t.prototype.getBaseboneConstraintUV=function(){return this._baseboneConstraintUV},t.prototype.getBaseLocation=function(){if(0!==this._chain.length)return this._chain[0].getStartLocation();throw new Error("Cannot get base location as there are zero bones in the chain.")},t.prototype.getBone=function(t){return this._chain[t]},t.prototype.getBoneConnectionPoint=function(){return this._boneConnectionPoint},t.prototype.getChain=function(){return this._chain},t.prototype.getChainLength=function(){return this._chainLength},t.prototype.getConnectedBoneNumber=function(){return this._connectedBoneNumber},t.prototype.getConnectedChainNumber=function(){return this._connectedChainNumber},t.prototype.getEffectorLocation=function(){if(0!==this._chain.length)return this._chain[this._chain.length-1].getEndLocation();throw new Error("Cannot get effector location as there are zero bones in the chain.")},t.prototype.getEmbeddedTargetMode=function(){return this._useEmbeddedTarget},t.prototype.getEmbeddedTarget=function(){return this._embeddedTarget},t.prototype.getLastTargetLocation=function(){return this._lastTargetLocation},t.prototype.getName=function(){return this._name},t.prototype.getNumBones=function(){return this._chain.length},t.prototype.removeBone=function(t){if(!(t<this._chain.length))throw new Error("Bone "+t+" does not exist to be removed from the chain. Bones are zero indexed.");this._chain.splice(t,1),this.updateChainLength()},t.prototype.setBaseboneConstraintType=function(t){this._baseboneConstraintType=t},t.prototype.setBaseboneConstraintUV=function(t){u.validateDirectionUV(t),this._baseboneConstraintUV.set(p.normalised(t))},t.prototype.setBaseLocation=function(t){this._baseLocation.set(t)},t.prototype.setBoneConnectionPoint=function(t){this._boneConnectionPoint=t},t.prototype.setChain=function(t){this._chain=t},t.prototype.setColour=function(t){for(var e=0,n=this._chain;e<n.length;e++){n[e].setColour(t)}},t.prototype.setConnectedBoneNumber=function(t){this._connectedBoneNumber=t},t.prototype.setConnectedChainNumber=function(t){this._connectedChainNumber=t},t.prototype.setFixedBaseMode=function(t){if(!t&&-1!==this._connectedChainNumber)throw new Error("This chain is connected to another chain so must remain in fixed base mode.");if(this._baseboneConstraintType===o.GLOBAL_ABSOLUTE&&!t)throw new Error("Cannot set a non-fixed base mode when the chain's constraint type is BaseBoneConstraintType2D.GLOBAL_ABSOLUTE.");this._fixedBaseMode=t},t.prototype.setMaxIterationAttempts=function(t){if(t<1)throw new Error("The maximum number of attempts to solve this IK chain must be at least 1.");this._maxIterationAttempts=t},t.prototype.setMinIterationChange=function(t){if(t<0)throw new Error("The minimum iteration change value must be more than or equal to zero.");this._minIterationChange=t},t.prototype.setName=function(t){this._name=t},t.prototype.setSolveDistanceThreshold=function(t){if(t<0)throw new Error("The solve distance threshold must be greater than or equal to zero.");this._solveDistanceThreshold=t},t.prototype.solveIK=function(t){for(var e=this._chain.length-1;e>=0;--e){var n=(d=this._chain[e]).getLength();if(e!==this._chain.length-1){var i=this._chain[e+1],r=i.getDirectionUV().negated(),s=d.getDirectionUV().negated(),h=i.getJoint().getClockwiseConstraintDegs(),c=i.getJoint().getAnticlockwiseConstraintDegs(),u=void 0;u=this._chain[e].getJointConstraintCoordinateSystem()==a.LOCAL?p.getConstrainedUV(s,r,h,c):p.getConstrainedUV(s,d.getGlobalConstraintUV().negated(),h,c);var g=d.getEndLocation().plus(u.times(n));d.setStartLocation(g),e>0&&this._chain[e-1].setEndLocation(g)}else{d.setEndLocation(t);s=d.getDirectionUV().negated(),u=void 0;if(e>0){var l=this._chain[e-1].getDirectionUV().negated();h=d.getJoint().getClockwiseConstraintDegs(),c=d.getJoint().getAnticlockwiseConstraintDegs();u=d.getJoint().getConstraintCoordinateSystem()==a.LOCAL?p.getConstrainedUV(s,l,h,c):p.getConstrainedUV(s,d.getGlobalConstraintUV().negated(),h,c)}else u=d.getJointConstraintCoordinateSystem()==a.LOCAL?s:p.getConstrainedUV(s,d.getGlobalConstraintUV().negated(),d.getClockwiseConstraintDegs(),d.getAnticlockwiseConstraintDegs());g=d.getEndLocation().plus(u.times(n));d.setStartLocation(g),e>0&&this._chain[e-1].setEndLocation(g)}}for(e=0;e<this._chain.length;++e){n=this._chain[e].getLength();var d=this._chain[e];if(0!==e){var _=this._chain[e-1],f=d.getDirectionUV(),m=_.getDirectionUV();h=d.getJoint().getClockwiseConstraintDegs(),c=d.getJoint().getAnticlockwiseConstraintDegs(),u=void 0;u=d.getJointConstraintCoordinateSystem()==a.LOCAL?p.getConstrainedUV(f,m,h,c):p.getConstrainedUV(f,d.getGlobalConstraintUV(),h,c);var L=d.getStartLocation().plus(u.times(n));d.setEndLocation(L),e<this._chain.length-1&&this._chain[e+1].setStartLocation(L)}else{if(this._fixedBaseMode)this._chain[0].setStartLocation(this._baseLocation);else{var y=this._chain[0].getDirectionUV(),C=this._chain[0].getEndLocation().minus(y.times(n));this._chain[0].setStartLocation(C)}if(this._baseboneConstraintType==o.NONE){f=d.getDirectionUV(),L=d.getStartLocation().plus(f.times(n));this._chain[0].setEndLocation(L),this._chain.length>1&&this._chain[1].setStartLocation(L)}else{f=d.getDirectionUV(),h=d.getJoint().getClockwiseConstraintDegs(),c=d.getJoint().getAnticlockwiseConstraintDegs(),u=void 0;u=this._baseboneConstraintType===o.LOCAL_ABSOLUTE?p.getConstrainedUV(f,this._baseboneRelativeConstraintUV,h,c):p.getConstrainedUV(f,this._baseboneConstraintUV,h,c);L=this._chain[e].getStartLocation().plus(u.times(n));this._chain[e].setEndLocation(L),e<this._chain.length-1&&this._chain[e+1].setStartLocation(L)}}}this._lastTargetLocation.set(t);var A=this._chain[this._chain.length-1].getEndLocation();return p.distanceBetween(A,t)},t.prototype.setEmbeddedTargetMode=function(t){this._useEmbeddedTarget=t},t.prototype.cloneChainVector=function(){for(var t=this._chain.length,e=[],n=0;n<t;++n){var i=new _;i.set(this._chain[n]),e.push(i)}return e},t.prototype.updateChainLength=function(){this._chainLength=0;for(var t=0,e=this._chain;t<e.length;t++){var n=e[t];this._chainLength+=n.getLength()}},t.prototype.updateEmbeddedTarget=function(t){if(!this._useEmbeddedTarget)throw new Error("This chain does not have embedded targets enabled - enable with setEmbeddedTargetMode(true).");this._embeddedTarget.set(t)},t.prototype.solveForEmbeddedTarget=function(){if(this._useEmbeddedTarget)return this.solveForTarget(this._embeddedTarget);throw new Error("This chain does not have embedded targets enabled - enable with setEmbeddedTargetMode(true).")},t.prototype.solveForTarget=function(t){if(this._lastTargetLocation.approximatelyEquals(t,.001)&&this._lastBaseLocation.approximatelyEquals(this._baseLocation,.001))return this._currentSolveDistance;var e,n=null;this._lastBaseLocation.approximatelyEquals(this._baseLocation,.001)?(e=p.distanceBetween(this._chain[this._chain.length-1].getEndLocation(),t),n=this.cloneChainVector()):e=Number.MAX_VALUE;for(var i,o=[],r=Number.MAX_VALUE,s=Number.MAX_VALUE,a=0;a<this._maxIterationAttempts;++a){if((i=this.solveIK(t))<r){if(r=i,o=this.cloneChainVector(),i<=this._solveDistanceThreshold)break}else if(Math.abs(i-s)<this._minIterationChange)break;s=i}return r<e?(this._currentSolveDistance=r,this._chain=o):(this._currentSolveDistance=e,this._chain=n),this._lastBaseLocation.set(this._baseLocation),this._lastTargetLocation.set(t),this._currentSolveDistance},t.prototype.getBaseboneRelativeConstraintUV=function(){return this._baseboneRelativeConstraintUV},t.prototype.setBaseboneRelativeConstraintUV=function(t){this._baseboneRelativeConstraintUV.set(t)},t.prototype.getMaxIterationAttempts=function(){return this._maxIterationAttempts},t.prototype.getMinIterationChange=function(){return this._minIterationChange},t.prototype.getSolveDistanceThreshold=function(){return this._solveDistanceThreshold},t}(),L=function(){function t(t){var e=this;this._chain=[],this._solveDistanceThreshold=.01,this._maxIterationAttempts=20,this._minIterationChange=.01,this._fixedBaseLocation=new l,this._fixedBaseMode=!0,this._baseboneConstraintType=i.NONE,this._baseboneConstraintUV=new l,this._baseboneRelativeConstraintUV=new l,this._baseboneRelativeReferenceConstraintUV=new l,this._lastTargetLocation=new l(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._lastBaseLocation=new l(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentSolveDistance=Number.MAX_VALUE,this._connectedChainNumber=-1,this._connectedBoneNumber=-1,this._embeddedTarget=new l,this._useEmbeddedTarget=!1,this.getBaseboneRelativeConstraintUV=function(){return e._baseboneRelativeConstraintUV},this.getBaseboneConstraintType=function(){return e._baseboneConstraintType},this.getBaseLocation=function(){return e._chain[0].getStartLocation()},this.getBone=function(t){return e._chain[t]},this.getChainLength=function(){return e._chainLength},this.getConnectedBoneNumber=function(){return e._connectedBoneNumber},this.getConnectedChainNumber=function(){return e._connectedChainNumber},this.getEmbeddedTarget=function(){return e._embeddedTarget},this.getLastTargetLocation=function(){return e._lastTargetLocation},this.getName=function(){return e._name},this.getNumBones=function(){return e._chain.length},this.getBaseboneRelativeReferenceConstraintUV=function(){return e._baseboneRelativeReferenceConstraintUV},t&&("string"==typeof t?this._name=t:(this._chain=t.cloneIkChain(),this._fixedBaseLocation.set(t.getBaseLocation()),this._lastTargetLocation.set(t._lastTargetLocation),this._lastBaseLocation.set(t._lastBaseLocation),this._embeddedTarget.set(t._embeddedTarget),t._baseboneConstraintType!=i.NONE&&(this._baseboneConstraintUV.set(t._baseboneConstraintUV),this._baseboneRelativeConstraintUV.set(t._baseboneRelativeConstraintUV)),this._chainLength=t._chainLength,this._currentSolveDistance=t._currentSolveDistance,this._connectedChainNumber=t._connectedChainNumber,this._connectedBoneNumber=t._connectedBoneNumber,this._baseboneConstraintType=t._baseboneConstraintType,this._name=t._name,this._useEmbeddedTarget=t._useEmbeddedTarget))}return t.prototype.addBone=function(t){this._chain.push(t),1==this._chain.length&&(this._fixedBaseLocation.set(t.getStartLocation()),this._baseboneConstraintUV=t.getDirectionUV()),this.updateChainLength()},t.prototype.addConsecutiveBone=function(t,e,n,i){if(u.validateDirectionUV(t),u.validateLength(e),0===this._chain.length)throw new Error("You cannot add the basebone as a consecutive bone as it does not provide a start location. Use the addBone() method instead.");var o=this._chain[this._chain.length-1].getEndLocation();this.addBone(new f(o,t.normalised(),e,n,i))},t.prototype.addConsecutiveCreatedBone=function(t){var e=t.getDirectionUV();u.validateDirectionUV(e);var n=t.getLength();if(u.validateLength(n),0===this._chain.length)throw new Error("You cannot add the base bone to a chain using this method as it does not provide a start location.");var i=this._chain[this._chain.length-1].getEndLocation();t.setStartLocation(i),t.setEndLocation(i.plus(e.times(n))),this.addBone(t)},t.prototype.addConsecutiveHingedBone=function(t,e,n,i,o,s,a,h){if(void 0===o&&(o=180),void 0===s&&(s=180),void 0===a&&(a=l.genPerpendicularVectorQuick(i)),void 0===h&&(h=new c),u.validateDirectionUV(t),u.validateDirectionUV(i),u.validateLength(e),0===this._chain.length)throw new Error("You must add a basebone before adding a consectutive bone.");t.normalise(),i.normalise();var g=this._chain[this._chain.length-1].getEndLocation(),p=new f(g,t,e,h),_=new d;switch(n){case r.GLOBAL_HINGE:_.setHingeJoint(r.GLOBAL_HINGE,i,o,s,a);break;case r.LOCAL_HINGE:_.setHingeJoint(r.LOCAL_HINGE,i,o,s,a);break;default:throw new Error("Hinge joint types may be only JointType.GLOBAL_HINGE or JointType.LOCAL_HINGE.")}p.setJoint(_),this.addBone(p)},t.prototype.addConsecutiveRotorConstrainedBone=function(t,e,n,i){if(void 0===n&&(n=180),void 0===i&&(i=new c),u.validateDirectionUV(t),u.validateLength(e),0===this._chain.length)throw new Error("Add a basebone before attempting to add consectuive bones.");var o=new f(this._chain[this._chain.length-1].getEndLocation(),t.normalise(),e,i);o.setBallJointConstraintDegs(n),this.addBone(o)},t.prototype.getBaseboneConstraintUV=function(){if(this._baseboneConstraintType!=i.NONE)return this._baseboneConstraintUV;throw new Error("Cannot return the basebone constraint when the basebone constraint type is NONE.")},t.prototype.getChain=function(){return this._chain},t.prototype.getEffectorLocation=function(){return this._chain[this._chain.length-1].getEndLocation()},t.prototype.getEmbeddedTargetMode=function(){return this._useEmbeddedTarget},t.prototype.removeBone=function(t){if(!(t<this._chain.length))throw new Error("Bone "+t+" does not exist to be removed from the chain. Bones are zero indexed.");this._chain.splice(t,1),this.updateChainLength()},t.prototype._setBaseboneRelativeConstraintUV=function(t){this._baseboneRelativeConstraintUV=t},t.prototype._setBaseboneRelativeReferenceConstraintUV=function(t){this._baseboneRelativeReferenceConstraintUV=t},t.prototype.setEmbeddedTargetMode=function(t){this._useEmbeddedTarget=t},t.prototype.setRotorBaseboneConstraint=function(t,e,n){if(0===this._chain.length)throw new Error("Chain must contain a basebone before we can specify the basebone constraint type.");if(e.length()<=0)throw new Error("Constraint axis cannot be zero.");if(n<0&&(n=0),n>180&&(n=180),t!=i.GLOBAL_ROTOR&&t!=i.LOCAL_ROTOR)throw new Error("The only valid rotor types for this method are GLOBAL_ROTOR and LOCAL_ROTOR.");this._baseboneConstraintType=t,this._baseboneConstraintUV=e.normalised(),this._baseboneRelativeConstraintUV.set(this._baseboneConstraintUV),this.getBone(0).getJoint().setAsBallJoint(n)},t.prototype.setHingeBaseboneConstraint=function(t,e,n,o,s){if(0===this._chain.length)throw new Error("Chain must contain a basebone before we can specify the basebone constraint type.");if(e.length()<=0)throw new Error("Hinge rotation axis cannot be zero.");if(s.length()<=0)throw new Error("Hinge reference axis cannot be zero.");if(!l.perpendicular(e,s))throw new Error("The hinge reference axis must be in the plane of the hinge rotation axis, that is, they must be perpendicular.");if(t!=i.GLOBAL_HINGE&&t!=i.LOCAL_HINGE)throw new Error("The only valid hinge types for this method are GLOBAL_HINGE and LOCAL_HINGE.");this._baseboneConstraintType=t,this._baseboneConstraintUV.set(e.normalised());var a=new d;t==i.GLOBAL_HINGE?a.setHingeJoint(r.GLOBAL_HINGE,e,n,o,s):a.setHingeJoint(r.LOCAL_HINGE,e,n,o,s),this.getBone(0).setJoint(a)},t.prototype.setBaseboneConstraintUV=function(t){if(this._baseboneConstraintType==i.NONE)throw new Error("Specify the basebone constraint type with setBaseboneConstraintTypeCannot specify a basebone constraint when the current constraint type is BaseboneConstraint.NONE.");u.validateDirectionUV(t),t.normalise(),this._baseboneConstraintUV.set(t)},t.prototype.setBaseLocation=function(t){this._fixedBaseLocation.set(t)},t.prototype.connectToStructure=function(t,e,n){var i=t.getNumChains();if(e>i)throw new Error("Structure does not contain a chain "+e+" - it has "+i+" chains.");var o=t.getChain(e).getNumBones();if(n>o)throw new Error("Chain does not contain a bone "+n+" - it has "+o+" bones.");this._connectedChainNumber=e,this._connectedBoneNumber=n},t.prototype.setFixedBaseMode=function(t){if(!t&&-1!=this._connectedChainNumber)throw new Error("This chain is connected to another chain so must remain in fixed base mode.");if(this._baseboneConstraintType==i.GLOBAL_ROTOR&&!t)throw new Error("Cannot set a non-fixed base mode when the chain's constraint type is BaseboneConstraintType3D.GLOBAL_ABSOLUTE_ROTOR.");this._fixedBaseMode=t},t.prototype.setMaxIterationAttempts=function(t){if(t<1)throw new Error("The maximum number of attempts to solve this IK chain must be at least 1.");this._maxIterationAttempts=t},t.prototype.setMinIterationChange=function(t){if(t<0)throw new Error("The minimum iteration change value must be more than or equal to zero.");this._minIterationChange=t},t.prototype.setName=function(t){this._name=t},t.prototype.setSolveDistanceThreshold=function(t){if(t<0)throw new Error("The solve distance threshold must be greater than or equal to zero.");this._solveDistanceThreshold=t},t.prototype.setColour=function(t){for(var e=0,n=this._chain;e<n.length;e++){n[e].setColour(t)}},t.prototype.solveForEmbeddedTarget=function(){if(this._useEmbeddedTarget)return this.solveForTarget(this._embeddedTarget);throw new Error("This chain does not have embedded targets enabled - enable with setEmbeddedTargetMode(true).")},t.prototype.solveForTarget=function(t){if(this._lastTargetLocation.approximatelyEquals(t,1e-5)&&!this._fixedBaseMode&&this._lastBaseLocation.approximatelyEquals(this.getBaseLocation(),1e-5)&&this._fixedBaseMode&&this._fixedBaseLocation.approximatelyEquals(this.getBaseLocation(),1e-5))return this._currentSolveDistance;for(var e,n=[],i=Number.MAX_VALUE,o=Number.MAX_VALUE,r=0;r<this._maxIterationAttempts;++r){if((e=this.solveIK(t))<i){if(i=e,n=this.cloneIkChain(),e<=this._solveDistanceThreshold)break}else if(Math.abs(e-o)<this._minIterationChange)break;o=e}return this._currentSolveDistance=i,this._chain=n,this._lastBaseLocation.set(this.getBaseLocation()),this._lastTargetLocation.set(t),this._currentSolveDistance},t.prototype.solveIK=function(t){if(0===this._chain.length)throw new Error("It makes no sense to solve an IK chain with zero bones.");for(var e=this._chain.length-1;e>=0;--e){var n=(f=this._chain[e]).getLength(),o=f.getJoint(),s=f.getJointType();if(e!=this._chain.length-1){var a=this._chain[e+1].getDirectionUV().negated(),h=f.getDirectionUV().negated();if(s==r.BALL)l.getAngleBetweenDegs(a,h)>(x=o.getBallJointConstraintDegs())&&(h=l.getAngleLimitedUnitVectorDegs(h,a,x));else if(s==r.GLOBAL_HINGE)h=h.projectOntoPlane(o.getHingeRotationAxis());else if(s==r.LOCAL_HINGE){var c=void 0,p=void 0;p=e>0?(c=g.createRotationMatrix(this._chain[e-1].getDirectionUV())).times(o.getHingeRotationAxis()).normalise():this._baseboneRelativeConstraintUV,h=h.projectOntoPlane(p)}var _=f.getEndLocation().plus(h.times(n));f.setStartLocation(_),e>0&&this._chain[e-1].setEndLocation(_)}else{f.setEndLocation(t);h=f.getDirectionUV().negated();switch(s){case r.BALL:break;case r.GLOBAL_HINGE:h=h.projectOntoPlane(o.getHingeRotationAxis());break;case r.LOCAL_HINGE:p=(c=g.createRotationMatrix(this._chain[e-1].getDirectionUV())).times(o.getHingeRotationAxis()).normalise();h=h.projectOntoPlane(p)}_=t.plus(h.times(n));f.setStartLocation(_),e>0&&this._chain[e-1].setEndLocation(_)}}for(e=0;e<this._chain.length;++e){var f;n=(f=this._chain[e]).getLength();if(0!=e){var m=f.getDirectionUV(),L=this._chain[e-1].getDirectionUV(),y=(o=f.getJoint()).getJointType();if(y==r.BALL)l.getAngleBetweenDegs(L,m)>(x=o.getBallJointConstraintDegs())&&(m=l.getAngleLimitedUnitVectorDegs(m,L,x));else if(y==r.GLOBAL_HINGE){var C=o.getHingeRotationAxis();m=m.projectOntoPlane(C);var A=-o.getHingeClockwiseConstraintDegs(),b=o.getHingeAnticlockwiseConstraintDegs();if(!u.approximatelyEquals(A,-d.MAX_CONSTRAINT_ANGLE_DEGS,.001)&&!u.approximatelyEquals(b,d.MAX_CONSTRAINT_ANGLE_DEGS,.001)){var v=o.getHingeReferenceAxis();(T=l.getSignedAngleBetweenDegs(v,m,C))>b?m=l.rotateAboutAxisDegs(v,b,C).normalised():T<A&&(m=l.rotateAboutAxisDegs(v,A,C).normalised())}}else if(y==r.LOCAL_HINGE){C=o.getHingeRotationAxis(),p=(c=g.createRotationMatrix(L)).times(C).normalise();m=m.projectOntoPlane(p);A=-o.getHingeClockwiseConstraintDegs(),b=o.getHingeAnticlockwiseConstraintDegs();if(!u.approximatelyEquals(A,-d.MAX_CONSTRAINT_ANGLE_DEGS,.001)&&!u.approximatelyEquals(b,d.MAX_CONSTRAINT_ANGLE_DEGS,.001)){var w=c.times(o.getHingeReferenceAxis()).normalise();(T=l.getSignedAngleBetweenDegs(w,m,p))>b?m=l.rotateAboutAxisDegs(w,b,p).normalise():T<A&&(m=l.rotateAboutAxisDegs(w,A,p).normalise())}}var E=f.getStartLocation().plus(m.times(n));f.setEndLocation(E),e<this._chain.length-1&&this._chain[e+1].setStartLocation(E)}else if(this._fixedBaseMode?f.setStartLocation(this._fixedBaseLocation):f.setStartLocation(f.getEndLocation().minus(f.getDirectionUV().times(n))),this._baseboneConstraintType==i.NONE){E=f.getStartLocation().plus(f.getDirectionUV().times(n));f.setEndLocation(E),this._chain.length>1&&this._chain[1].setStartLocation(E)}else if(this._baseboneConstraintType==i.GLOBAL_ROTOR){m=f.getDirectionUV();l.getAngleBetweenDegs(this._baseboneConstraintUV,m)>(x=f.getBallJointConstraintDegs())&&(m=l.getAngleLimitedUnitVectorDegs(m,this._baseboneConstraintUV,x));E=f.getStartLocation().plus(m.times(n));f.setEndLocation(E),this._chain.length>1&&this._chain[1].setStartLocation(E)}else if(this._baseboneConstraintType==i.LOCAL_ROTOR){var x;m=f.getDirectionUV();l.getAngleBetweenDegs(this._baseboneRelativeConstraintUV,m)>(x=f.getBallJointConstraintDegs())&&(m=l.getAngleLimitedUnitVectorDegs(m,this._baseboneRelativeConstraintUV,x));E=f.getStartLocation().plus(m.times(n));f.setEndLocation(E),this._chain.length>1&&this._chain[1].setStartLocation(E)}else if(this._baseboneConstraintType==i.GLOBAL_HINGE){C=(D=f.getJoint()).getHingeRotationAxis(),A=-D.getHingeClockwiseConstraintDegs(),b=D.getHingeAnticlockwiseConstraintDegs(),m=f.getDirectionUV().projectOntoPlane(C);if(!u.approximatelyEquals(A,-d.MAX_CONSTRAINT_ANGLE_DEGS,.01)||!u.approximatelyEquals(b,d.MAX_CONSTRAINT_ANGLE_DEGS,.01)){v=D.getHingeReferenceAxis();(T=l.getSignedAngleBetweenDegs(v,m,C))>b?m=l.rotateAboutAxisDegs(v,b,C).normalise():T<A&&(m=l.rotateAboutAxisDegs(v,A,C).normalise())}E=f.getStartLocation().plus(m.times(n));f.setEndLocation(E),this._chain.length>1&&this._chain[1].setStartLocation(E)}else if(this._baseboneConstraintType==i.LOCAL_HINGE){var D=f.getJoint();C=this._baseboneRelativeConstraintUV,A=-D.getHingeClockwiseConstraintDegs(),b=D.getHingeAnticlockwiseConstraintDegs(),m=f.getDirectionUV().projectOntoPlane(C);if(!u.approximatelyEquals(A,-d.MAX_CONSTRAINT_ANGLE_DEGS,.01)||!u.approximatelyEquals(b,d.MAX_CONSTRAINT_ANGLE_DEGS,.01)){var T;v=this._baseboneRelativeReferenceConstraintUV;(T=l.getSignedAngleBetweenDegs(v,m,C))>b?m=l.rotateAboutAxisDegs(v,b,C).normalise():T<A&&(m=l.rotateAboutAxisDegs(v,A,C).normalise())}E=f.getStartLocation().plus(m.times(n));f.setEndLocation(E),this._chain.length>1&&this._chain[1].setStartLocation(E)}}return this._lastTargetLocation.set(t),l.distanceBetween(this._chain[this._chain.length-1].getEndLocation(),t)},t.prototype.updateChainLength=function(){this._chainLength=0;for(var t=0,e=this._chain;t<e.length;t++){var n=e[t];this._chainLength+=n.getLength()}},t.prototype.updateEmbeddedTarget=function(t){if(!this._useEmbeddedTarget)throw new Error("This chain does not have embedded targets enabled - enable with setEmbeddedTargetMode(true).");this._embeddedTarget.set(t)},t.prototype.cloneIkChain=function(){for(var t=[],e=0,n=this._chain;e<n.length;e++){var i=n[e],o=new f;o.set(i),t.push(o)}return t},t.prototype.getMaxIterationAttempts=function(){return this._maxIterationAttempts},t.prototype.getMinIterationChange=function(){return this._minIterationChange},t.prototype.getSolveDistanceThreshold=function(){return this._solveDistanceThreshold},t}(),y=function(){function t(t){void 0===t&&(t=""),this._name="",this._chains=[],this._name=t}return t.prototype.setName=function(t){this._name=t},t.prototype.solveForTarget=function(e){for(var n,i,r=this._chains.length,a=0;a<r;++a){n=(i=this._chains[a]).getConnectedChainNumber();var h=i.getBaseboneConstraintType();if(-1!==n&&h!==o.GLOBAL_ABSOLUTE){var c=this._chains[n].getBone(this._chains[a].getConnectedBoneNumber());i.getBoneConnectionPoint()==s.START?i.setBaseLocation(c.getStartLocation()):i.setBaseLocation(c.getEndLocation());var u=c.getDirectionUV();if(h==o.LOCAL_RELATIVE)this._chains[a].setBaseboneConstraintUV(u);else if(h==o.LOCAL_ABSOLUTE){var g=t.UP.getSignedAngleDegsTo(u),l=p.rotateDegs(i.getBaseboneConstraintUV(),g);i.setBaseboneRelativeConstraintUV(l)}}i.getEmbeddedTargetMode()?i.solveForEmbeddedTarget():i.solveForTarget(e)}},t.prototype.addChain=function(t){this._chains.push(t)},t.prototype.connectChain=function(t,e,n,i,o){if(t.setBoneConnectionPoint(i),e>=this._chains.length)throw new Error("Cannot connect to chain "+e+" - no such chain (remember that chains are zero indexed).");if(n>=this._chains[e].getNumBones())throw new Error("Cannot connect to bone "+n+" of chain "+e+" - no such bone (remember that bones are zero indexed).");var r,a=new m(t);if(a.setConnectedChainNumber(e),a.setConnectedBoneNumber(n),r=t.getBoneConnectionPoint()==s.START?this._chains[e].getBone(n).getStartLocation():this._chains[e].getBone(n).getEndLocation(),a.setBaseLocation(r),a.setFixedBaseMode(!0),o)for(var h=0;h<t.getNumBones();++h){var c=a.getBone(h).getStartLocation(),u=a.getBone(h).getEndLocation(),g=c.plus(r),l=u.plus(r);a.getBone(h).setStartLocation(g),a.getBone(h).setEndLocation(l)}this.addChain(a)},t.prototype.getNumChains=function(){return this._chains.length},t.prototype.getChain=function(t){return this._chains[t]},t.prototype.getName=function(){return this._name},t.UP=new p(0,1),t}(),C=function(){function t(t){void 0===t&&(t=""),this._name="",this._chains=[],this._name=t}return t.prototype.solveForTarget=function(t){for(var e,n=this._chains.length,o=0;o<n;++o){var r=this._chains[o];if(-1===(e=r.getConnectedChainNumber()))r.getEmbeddedTargetMode()?r.solveForEmbeddedTarget():r.solveForTarget(t);else{var a=this._chains[e].getBone(r.getConnectedBoneNumber());a.getBoneConnectionPoint()==s.START?r.setBaseLocation(a.getStartLocation()):r.setBaseLocation(a.getEndLocation());var h=r.getBaseboneConstraintType();switch(h){case i.NONE:case i.GLOBAL_ROTOR:case i.GLOBAL_HINGE:break;case i.LOCAL_ROTOR:case i.LOCAL_HINGE:var c=g.createRotationMatrix(a.getDirectionUV()),u=c.times(r.getBaseboneConstraintUV()).normalised();r._setBaseboneRelativeConstraintUV(u),h==i.LOCAL_HINGE&&r._setBaseboneRelativeReferenceConstraintUV(c.times(r.getBone(0).getJoint().getHingeReferenceAxis()))}r.getEmbeddedTargetMode()?r.solveForEmbeddedTarget():r.solveForTarget(t)}}},t.prototype.addChain=function(t){this._chains.push(t)},t.prototype.removeChain=function(t){this._chains.splice(t,1)},t.prototype.connectChain=function(t,e,n,i,o){if(e>this._chains.length)throw new Error("Cannot connect to chain "+e+" - no such chain (remember that chains are zero indexed).");if(n>this._chains[e].getNumBones())throw new Error("Cannot connect to bone "+n+" of chain "+e+" - no such bone (remember that bones are zero indexed).");var r,a=new L(t);if(a.connectToStructure(this,e,n),this.getChain(e).getBone(n).setBoneConnectionPoint(i),r=i==s.START?this._chains[e].getBone(n).getStartLocation():this._chains[e].getBone(n).getEndLocation(),a.setBaseLocation(r),a.setFixedBaseMode(!0),o)for(var h=0;h<a.getNumBones();++h){var c=a.getBone(h).getStartLocation(),u=a.getBone(h).getEndLocation(),g=c.plus(r),l=u.plus(r);a.getBone(h).setStartLocation(g),a.getBone(h).setEndLocation(l)}this.addChain(a)},t.prototype.getNumChains=function(){return this._chains.length},t.prototype.getChain=function(t){return this._chains[t]},t.prototype.setName=function(t){this._name=t},t.prototype.getName=function(){return this._name},t}(),A=function(){function t(){this.raw=t.identity()}return t.prototype.vtranslate=function(e){return t.translate(this.raw,e.x,e.y,e.z),this},t.prototype.rotateY=function(e){return t.rotateY(this.raw,e),this},t.prototype.rotateX=function(e){return t.rotateX(this.raw,e),this},t.prototype.rotateZ=function(e){return t.rotateZ(this.raw,e),this},t.prototype.vscale=function(e){return t.scale(this.raw,e.x,e.y,e.z),this},t.prototype.reset=function(){for(var t=0;t<this.raw.length;t++)this.raw[t]=t%5==0?1:0;return this},t.identity=function(){var t=new Float32Array(16);return t[0]=t[5]=t[10]=t[15]=1,t},t.perspective=function(t,e,n,i,o){var r=1/Math.tan(e/2),s=1/(i-o);t[0]=r/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(o+i)*s,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*o*i*s,t[15]=0},t.normalMat3=function(t,e){var n=e[0],i=e[1],o=e[2],r=e[3],s=e[4],a=e[5],h=e[6],c=e[7],u=e[8],g=e[9],l=e[10],d=e[11],p=e[12],_=e[13],f=e[14],m=e[15],L=n*a-i*s,y=n*h-o*s,C=n*c-r*s,A=i*h-o*a,b=i*c-r*a,v=o*c-r*h,w=u*_-g*p,E=u*f-l*p,x=u*m-d*p,D=g*f-l*_,T=g*m-d*_,B=l*m-d*f,S=L*B-y*T+C*D+A*x-b*E+v*w;return S?(S=1/S,t[0]=(a*B-h*T+c*D)*S,t[1]=(h*x-s*B-c*E)*S,t[2]=(s*T-a*x+c*w)*S,t[3]=(o*T-i*B-r*D)*S,t[4]=(n*B-o*x+r*E)*S,t[5]=(i*x-n*T-r*w)*S,t[6]=(_*v-f*b+m*A)*S,t[7]=(f*C-p*v-m*y)*S,t[8]=(p*b-_*C+m*L)*S,t):null},t.transformVec4=function(t,e,n){return t[0]=n[0]*e[0]+n[4]*e[1]+n[8]*e[2]+n[12]*e[3],t[1]=n[1]*e[0]+n[5]*e[1]+n[9]*e[2]+n[13]*e[3],t[2]=n[2]*e[0]+n[6]*e[1]+n[10]*e[2]+n[14]*e[3],t[3]=n[3]*e[0]+n[7]*e[1]+n[11]*e[2]+n[15]*e[3],t},t.scale=function(t,e,n,i){return t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t[4]*=n,t[5]*=n,t[6]*=n,t[7]*=n,t[8]*=i,t[9]*=i,t[10]*=i,t[11]*=i,t},t.rotateY=function(t,e){var n=Math.sin(e),i=Math.cos(e),o=t[0],r=t[1],s=t[2],a=t[3],h=t[8],c=t[9],u=t[10],g=t[11];return t[0]=o*i-h*n,t[1]=r*i-c*n,t[2]=s*i-u*n,t[3]=a*i-g*n,t[8]=o*n+h*i,t[9]=r*n+c*i,t[10]=s*n+u*i,t[11]=a*n+g*i,t},t.rotateX=function(t,e){var n=Math.sin(e),i=Math.cos(e),o=t[4],r=t[5],s=t[6],a=t[7],h=t[8],c=t[9],u=t[10],g=t[11];return t[4]=o*i+h*n,t[5]=r*i+c*n,t[6]=s*i+u*n,t[7]=a*i+g*n,t[8]=h*i-o*n,t[9]=c*i-r*n,t[10]=u*i-s*n,t[11]=g*i-a*n,t},t.rotateZ=function(t,e){var n=Math.sin(e),i=Math.cos(e),o=t[0],r=t[1],s=t[2],a=t[3],h=t[4],c=t[5],u=t[6],g=t[7];return t[0]=o*i+h*n,t[1]=r*i+c*n,t[2]=s*i+u*n,t[3]=a*i+g*n,t[4]=h*i-o*n,t[5]=c*i-r*n,t[6]=u*i-s*n,t[7]=g*i-a*n,t},t.invert=function(t,e){void 0===e&&(e=t);var n=e[0],i=e[1],o=e[2],r=e[3],s=e[4],a=e[5],h=e[6],c=e[7],u=e[8],g=e[9],l=e[10],d=e[11],p=e[12],_=e[13],f=e[14],m=e[15],L=n*a-i*s,y=n*h-o*s,C=n*c-r*s,A=i*h-o*a,b=i*c-r*a,v=o*c-r*h,w=u*_-g*p,E=u*f-l*p,x=u*m-d*p,D=g*f-l*_,T=g*m-d*_,B=l*m-d*f,S=L*B-y*T+C*D+A*x-b*E+v*w;return!!S&&(S=1/S,t[0]=(a*B-h*T+c*D)*S,t[1]=(o*T-i*B-r*D)*S,t[2]=(_*v-f*b+m*A)*S,t[3]=(l*b-g*v-d*A)*S,t[4]=(h*x-s*B-c*E)*S,t[5]=(n*B-o*x+r*E)*S,t[6]=(f*C-p*v-m*y)*S,t[7]=(u*v-l*C+d*y)*S,t[8]=(s*T-a*x+c*w)*S,t[9]=(i*x-n*T-r*w)*S,t[10]=(p*b-_*C+m*L)*S,t[11]=(g*C-u*b-d*L)*S,t[12]=(a*E-s*D-h*w)*S,t[13]=(n*D-i*E+o*w)*S,t[14]=(_*y-p*A-f*L)*S,t[15]=(u*A-g*y+l*L)*S,!0)},t.translate=function(t,e,n,i){t[12]=t[0]*e+t[4]*n+t[8]*i+t[12],t[13]=t[1]*e+t[5]*n+t[9]*i+t[13],t[14]=t[2]*e+t[6]*n+t[10]*i+t[14],t[15]=t[3]*e+t[7]*n+t[11]*i+t[15]},t}(),b=function(){function t(){this.position=new l(0,0,0),this.scale=new l(1,1,1),this.rotation=new l(0,0,0),this.matView=new A,this.matNormal=new Float32Array(9),this.forward=new Float32Array(4),this.up=new Float32Array(4),this.right=new Float32Array(4)}return t.prototype.updateMatrix=function(){return this.matView.reset().vtranslate(this.position).rotateX(this.rotation.x*u.DEGS_TO_RADS).rotateZ(this.rotation.z*u.DEGS_TO_RADS).rotateY(this.rotation.y*u.DEGS_TO_RADS).vscale(this.scale),A.normalMat3(this.matNormal,this.matView.raw),A.transformVec4(this.forward,[0,0,1,0],this.matView.raw),A.transformVec4(this.up,[0,1,0,0],this.matView.raw),A.transformVec4(this.right,[1,0,0,0],this.matView.raw),this.matView.raw},t.prototype.updateDirection=function(){return A.transformVec4(this.forward,[0,0,1,0],this.matView.raw),A.transformVec4(this.up,[0,1,0,0],this.matView.raw),A.transformVec4(this.right,[1,0,0,0],this.matView.raw),this},t.prototype.getViewMatrix=function(){return this.matView.raw},t.prototype.reset=function(){this.position.set(0,0,0),this.scale.set(1,1,1),this.rotation.set(0,0,0)},t}(),v=function(){function t(t,e,n,i){void 0===e&&(e=45),void 0===n&&(n=.1),void 0===i&&(i=100),this.projectionMatrix=new Float32Array(16);var o=t.canvas.width/t.canvas.height;A.perspective(this.projectionMatrix,e,o,n,i),this.transform=new b,this.viewMatrix=new Float32Array(16)}return t.prototype.panX=function(t){this.updateViewMatrix(),this.transform.position.x+=t},t.prototype.panY=function(t){this.updateViewMatrix(),this.transform.position.y+=this.transform.up[1]*t},t.prototype.panZ=function(t){this.updateViewMatrix(),this.transform.position.z+=t},t.prototype.updateViewMatrix=function(){return this.transform.matView.reset().rotateX(this.transform.rotation.x*u.DEGS_TO_RADS).rotateY(this.transform.rotation.y*u.DEGS_TO_RADS).vtranslate(this.transform.position),this.transform.updateDirection(),A.invert(this.viewMatrix,this.transform.matView.raw),this.viewMatrix},t}(),w=function(){function t(t,e){this.rotateRate=-300,this.panRate=5,this.zoomRate=200,this.prevX=0,this.prevY=0;var n=this,i=t.canvas.getBoundingClientRect();this.canvas=t.canvas,this.camera=e,this.offsetX=i.left,this.offsetY=i.top,2!==I&&(this.onUpHandler=function(){n.onMouseUp()},this.onMoveHandler=function(t){n.onMouseMove(t)},this.canvas.addEventListener("mousedown",function(t){n.onMouseDown(t)})),this.canvas.addEventListener("mousewheel",function(t){n.onMouseWheel(t)})}return t.prototype.onMouseDown=function(t){this.prevX=t.pageX-this.offsetX,this.prevY=t.pageY-this.offsetY,this.canvas.addEventListener("mouseup",this.onUpHandler),this.canvas.addEventListener("mousemove",this.onMoveHandler)},t.prototype.onMouseUp=function(){this.canvas.removeEventListener("mouseup",this.onUpHandler),this.canvas.removeEventListener("mousemove",this.onMoveHandler)},t.prototype.onMouseWheel=function(t){var e=Math.max(-1,Math.min(1,t.wheelDelta||-t.detail));this.camera.panZ(e*(this.zoomRate/this.canvas.height))},t.prototype.onMouseMove=function(t){var e=t.pageX-this.offsetX,n=t.pageY-this.offsetY,i=e-this.prevX,o=n-this.prevY;t.shiftKey&&2!==I?(this.camera.panX(-i*(this.panRate/this.canvas.width)),this.camera.panY(o*(this.panRate/this.canvas.height))):(this.camera.transform.rotation.y+=i*(this.rotateRate/this.canvas.width),this.camera.transform.rotation.x+=o*(this.rotateRate/this.canvas.height)),this.prevX=e,this.prevY=n},t}(),E=function(){function t(t){this.transform=new b,this.mesh=t}return t.prototype.setScale=function(t,e,n){return this.transform.scale.set(t,e,n),this},t.prototype.setPosition=function(t,e,n){return this.transform.position.set(t,e,n),this},t.prototype.setRotation=function(t,e,n){return this.transform.rotation.set(t,e,n),this},t.prototype.addScale=function(t,e,n){return this.transform.scale.x+=t,this.transform.scale.y+=e,this.transform.scale.z+=n,this},t.prototype.addPosition=function(t,e,n){return this.transform.position.x+=t,this.transform.position.y+=e,this.transform.position.z+=n,this},t.prototype.addRotation=function(t,e,n){return this.transform.rotation.x+=t,this.transform.rotation.y+=e,this.transform.rotation.z+=n,this},t.prototype.preRender=function(){return this.transform.updateMatrix(),this},t}(),x={};x.Primitive=function(){function t(){}return t.createModal=function(t,e,n,i){return new E(x.Primitive.createMesh(t,e,n,i))},t.createMesh=function(t,e,n,i){var o=t.fCreateMeshVAO(e,n,i,t.LINES);return o.noCulling=!0,o.doBlending=!0,o},t}(),x.Point=function(){function t(){}return t.createModal=function(t,e,n,i){return new E(x.Point.createMesh(t,e,n,i))},t.createMesh=function(t,e,n,i){var o=t.fCreateMeshVAO(e,n,i,t.POINTS);return o.noCulling=!0,o.doBlending=!0,o},t}(),x.GridAxis=function(){function t(){}return t.createModal=function(t,e){return new E(x.GridAxis.createMesh(t,e))},t.createMesh=function(t,e){var n,i=[],o=2===I?7:2,r=2===I?20:10,s=o/r,a=o/2;if(2===I)for(var h=0;h<=r;h++)n=h*s-a,i.push(n),i.push(a),i.push(0),i.push(0),i.push(n),i.push(-a),i.push(0),i.push(0),n=a-h*s,i.push(-a),i.push(n),i.push(0),i.push(0),i.push(a),i.push(n),i.push(0),i.push(0);else for(h=0;h<=r;h++)n=h*s-a,i.push(n),i.push(0),i.push(a),i.push(0),i.push(n),i.push(0),i.push(-a),i.push(0),n=a-h*s,i.push(-a),i.push(0),i.push(n),i.push(0),i.push(a),i.push(0),i.push(n),i.push(0);e&&(i.push(-o/2),i.push(0),i.push(0),i.push(1),i.push(o/2),i.push(0),i.push(0),i.push(1),i.push(0),i.push(-o/2),i.push(0),i.push(2),i.push(0),i.push(o/2),i.push(0),i.push(2),i.push(0),i.push(0),i.push(-o/2),i.push(3),i.push(0),i.push(0),i.push(o/2),i.push(3));var c,u={drawMode:t.LINES,vao:t.createVertexArray(),vertexComponentLen:4};return u.vertexCount=i.length/u.vertexComponentLen,c=Float32Array.BYTES_PER_ELEMENT*u.vertexComponentLen,u.bufVertices=t.createBuffer(),t.bindVertexArray(u.vao),t.bindBuffer(t.ARRAY_BUFFER,u.bufVertices),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),t.enableVertexAttribArray(O),t.enableVertexAttribArray(4),t.vertexAttribPointer(O,3,t.FLOAT,!1,c,0),t.vertexAttribPointer(4,1,t.FLOAT,!1,c,3*Float32Array.BYTES_PER_ELEMENT),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.mMeshCache.grid=u,u},t}();var D,T=(D=function(t,e){return(D=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}D(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),B=function(){function t(t,e,n){this.program=S.createProgramFromText(t,e,n),null!==this.program&&(this.gl=t,t.useProgram(this.program),this.attribLoc=S.getStandardAttribLocations(t,this.program),this.uniformLoc=S.getStandardUniformLocations(t,this.program))}return t.prototype.activate=function(){return this.gl.useProgram(this.program),this},t.prototype.deactivate=function(){return this.gl.useProgram(null),this},t.prototype.setPerspective=function(t){return this.gl.uniformMatrix4fv(this.uniformLoc.perspective,!1,t),this},t.prototype.setModalMatrix=function(t){return this.gl.uniformMatrix4fv(this.uniformLoc.modalMatrix,!1,t),this},t.prototype.setCameraMatrix=function(t){return this.gl.uniformMatrix4fv(this.uniformLoc.cameraMatrix,!1,t),this},t.prototype.dispose=function(){this.gl.getParameter(this.gl.CURRENT_PROGRAM)===this.program&&this.gl.useProgram(null),this.gl.deleteProgram(this.program)},t.prototype.preRender=function(){},t.prototype.renderModal=function(t){return this.setModalMatrix(t.transform.getViewMatrix()),this.gl.bindVertexArray(t.mesh.vao),t.mesh.noCulling&&this.gl.disable(this.gl.CULL_FACE),t.mesh.doBlending&&this.gl.enable(this.gl.BLEND),t.mesh.indexCount?this.gl.drawElements(t.mesh.drawMode,t.mesh.indexCount,this.gl.UNSIGNED_SHORT,0):this.gl.drawArrays(t.mesh.drawMode,0,t.mesh.vertexCount),this.gl.bindVertexArray(null),t.mesh.noCulling&&this.gl.enable(this.gl.CULL_FACE),t.mesh.doBlending&&this.gl.disable(this.gl.BLEND),this},t}(),S=function(){function t(){}return t.createShader=function(t,e,n){var i=t.createShader(n);return t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.error("Error compiling shader : "+e,t.getShaderInfoLog(i)),t.deleteShader(i),null)},t.createProgram=function(t,e,n,i){var o=t.createProgram();return t.attachShader(o,e),t.attachShader(o,n),t.bindAttribLocation(o,O,V),t.bindAttribLocation(o,G,U),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?i&&(t.validateProgram(o),!t.getProgramParameter(o,t.VALIDATE_STATUS))?(console.error("Error validating program",t.getProgramInfoLog(o)),t.deleteProgram(o),null):(t.detachShader(o,e),t.detachShader(o,n),t.deleteShader(n),t.deleteShader(e),o):(console.error("Error creating shader program.",t.getProgramInfoLog(o)),t.deleteProgram(o),null)},t.createProgramFromText=function(e,n,i){var o=t.createShader(e,n,e.VERTEX_SHADER);if(!o)return null;var r=t.createShader(e,i,e.FRAGMENT_SHADER);return r?t.createProgram(e,o,r,!0):(e.deleteShader(o),null)},t.getStandardAttribLocations=function(t,e){return{position:t.getAttribLocation(e,V),color:t.getAttribLocation(e,U)}},t.getStandardUniformLocations=function(t,e){return{perspective:t.getUniformLocation(e,"uPMatrix"),modalMatrix:t.getUniformLocation(e,"uMVMatrix"),cameraMatrix:t.getUniformLocation(e,"uCameraMatrix"),mainTexture:t.getUniformLocation(e,"uMainTex")}},t}(),N=function(t){function e(e,n){var i=this;(i=t.call(this,e,"#version 300 es\nin vec3 a_position;layout(location=4) in float a_color;uniform mat4 uPMatrix;uniform mat4 uMVMatrix;uniform mat4 uCameraMatrix;uniform vec3 uColor[4];out lowp vec4 color;void main(void){color = vec4(uColor[ int(a_color) ],1.0);gl_Position = uPMatrix * uCameraMatrix * uMVMatrix * vec4(a_position, 1.0);}","#version 300 es\nprecision mediump float;in vec4 color;out vec4 finalColor;void main(void){ finalColor = color; }")||this).setPerspective(n);var o=e.getUniformLocation(i.program,"uColor");return e.uniform3fv(o,new Float32Array([.8,.8,.8,1,0,0,0,1,0,0,0,1])),e.useProgram(null),i}return T(e,t),e}(B),M=function(t){function e(e,n){var i=this;return(i=t.call(this,e,"#version 300 es\n\t\tin vec3 a_position;\n\t\tin vec4 a_color;\n\n\t\tuniform mat4 uPMatrix;\n\t\tuniform mat4 uMVMatrix;\n\t\tuniform mat4 uCameraMatrix;\n\n\t\tout vec4 color;\n\n\t\tvoid main(void) {\n\t\t\tgl_PointSize = 4.0;\n\t\t\tcolor = a_color;\n\t\t\tgl_Position = uPMatrix * uCameraMatrix * uMVMatrix * vec4(a_position, 1.0); \n\t\t}","#version 300 es\n\t\tprecision mediump float;\n\t\tin vec4 color;\n\n\t\tout vec4 finalColor;\n\t\t\n\t\tvoid main(void) {\n\t\t\tfinalColor = color;\n\t\t}")||this).setPerspective(n),e.useProgram(null),i}return T(e,t),e}(B),R=function(){function t(t,e){var n=this;this.msLastFrame=null,this.callBack=t,this.isActive=!1,this.fps=0,void 0!==e&&e>0?(this.msFpsLimit=1e3/e,this.run=function(){var t=performance.now(),e=t-n.msLastFrame,i=e/1e3;e>=n.msFpsLimit&&(n.fps=Math.floor(1/i),n.msLastFrame=t,n.callBack(i)),n.isActive&&window.requestAnimationFrame(n.run)}):this.run=function(){var t=performance.now(),e=(t-n.msLastFrame)/1e3;n.fps=Math.floor(1/e),n.msLastFrame=t,n.callBack(e),n.isActive&&window.requestAnimationFrame(n.run)}}return t.prototype.start=function(){return this.isActive=!0,this.msLastFrame=performance.now(),window.requestAnimationFrame(this.run),this},t.prototype.stop=function(){this.isActive=!1},t}(),V="a_position",O=0,U="a_color",G=1,I=3,P=function(){function t(t,e){var n=this;this._primitives=[],this._points=[],this.onRender=function(){n.gCamera.updateViewMatrix(),n.gl.fClear(),n.gGridShader&&n.gGridShader.activate().setCameraMatrix(n.gCamera.viewMatrix).renderModal(n.gGridModal.preRender());for(var t=0,e=n._primitives;t<e.length;t++){var i=e[t];i.gShader.activate().setCameraMatrix(n.gCamera.viewMatrix).renderModal(i.gModal.preRender())}for(var o=0,r=n._points;o<r.length;o++){var s=r[o];s.gShader.activate().setCameraMatrix(n.gCamera.viewMatrix).renderModal(s.gModal.preRender())}},2===e&&(I=e),this.canvas=document.getElementById(t);var i=this.gl=this.canvas.getContext("webgl2");i?(i.mMeshCache=[],i.cullFace(i.BACK),i.frontFace(i.CCW),i.enable(i.DEPTH_TEST),i.enable(i.CULL_FACE),i.depthFunc(i.LEQUAL),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.clearColor(.95,.95,.95,1),i.fClear=function(){return this.clear(this.COLOR_BUFFER_BIT|this.DEPTH_BUFFER_BIT),this},i.fCreateArrayBuffer=function(t,e){void 0===e&&(e=!0);var n=this.createBuffer();return this.bindBuffer(this.ARRAY_BUFFER,n),this.bufferData(this.ARRAY_BUFFER,t,e?this.STATIC_DRAW:this.DYNAMIC_DRAW),this.bindBuffer(this.ARRAY_BUFFER,null),n},i.fCreateMeshVAO=function(t,e,n,i){void 0===i&&(i=this.LINES);var o={drawMode:i};return o.vao=this.createVertexArray(),this.bindVertexArray(o.vao),e&&(o.bufVertices=this.createBuffer(),o.vertexComponentLen=3,o.vertexCount=e.length/o.vertexComponentLen,this.bindBuffer(this.ARRAY_BUFFER,o.bufVertices),this.bufferData(this.ARRAY_BUFFER,new Float32Array(e),this.STATIC_DRAW),this.enableVertexAttribArray(O),this.vertexAttribPointer(O,3,this.FLOAT,!1,0,0)),n&&(o.bufColors=this.createBuffer(),this.bindBuffer(this.ARRAY_BUFFER,o.bufColors),this.bufferData(this.ARRAY_BUFFER,new Float32Array(n),this.STATIC_DRAW),this.enableVertexAttribArray(G),this.vertexAttribPointer(G,4,this.FLOAT,!1,0,0)),this.bindVertexArray(null),this.bindBuffer(this.ARRAY_BUFFER,null),this.mMeshCache[t]=o,o},i.fSetSize=function(t,e){return this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.canvas.width=t,this.canvas.height=e,this.viewport(0,0,t,e),this},i.fFitScreen=function(t,e){return void 0===t&&(t=1),void 0===e&&(e=1),this.fSetSize(window.innerWidth*t,window.innerHeight*e)}):console.error("WebGL context is not available.")}return t.prototype.init=function(t,e){this.gl.fFitScreen(1,1).fClear(),this.gCamera=new v(this.gl),this.gCamera.transform.position.set(0,2===I?0:.3,3),this.gCameraCtrl=new w(this.gl,this.gCamera),t&&(this.gGridShader=new N(this.gl,this.gCamera.projectionMatrix),this.gGridModal=x.GridAxis.createModal(this.gl,e)),this.RLoop=new R(this.onRender,30).start()},t.prototype.addPrimitive=function(t){var e=new z(this.gl,this.gCamera,t);return this._primitives.push(e),e},t.prototype.addPoint=function(t,e){this._points.push(new k(this.gl,this.gCamera,t,e))},t}(),k=function(){return function(t,e,n,i){this.gShader=new M(t,e.projectionMatrix),this.gModal=x.Point.createModal(t,"point",n.toArray(),i.toArray())}}(),z=function(){function t(t,e,n){this.structure=n,this.parseStructure(),this.gl=t,this.gShader=new M(t,e.projectionMatrix),this.gModal=x.Primitive.createModal(t,this.name,this.verts,this.colors)}return t.prototype.parseStructure=function(){var t,e,n,i;this.name=this.structure.getName(),this.effectors=[],this.colors=[],this.verts=[];for(var o=0;o<this.structure.getNumChains();o++){for(var r=0,s=this.structure.getChain(o).getChain();r<s.length;r++){var a=s[r];(t=this.colors).push.apply(t,a.getColour().toArray()),(e=this.colors).push.apply(e,a.getColour().toArray()),(n=this.verts).push.apply(n,a.getStartLocationAsArray()),2===I&&this.verts.push(0),(i=this.verts).push.apply(i,a.getEndLocationAsArray()),2===I&&this.verts.push(0)}this.effectors.push(this.structure.getChain(o))}},t.prototype.moveTo=function(t,e){for(var n=0;n<this.structure.getNumChains();n++)this.structure.getChain(n).setEmbeddedTargetMode(t!==n),t!==n&&this.structure.getChain(n).updateEmbeddedTarget(this.structure.getChain(n).getEffectorLocation());this.structure.solveForTarget(e),this.parseStructure(),this.gModal=x.Primitive.createModal(this.gl,this.name,this.verts,this.colors)},t}();n.d(e,"BaseboneConstraintType3D",function(){return i}),n.d(e,"BaseboneConstraintType2D",function(){return o}),n.d(e,"JointType",function(){return r}),n.d(e,"BoneConnectionPoint",function(){return s}),n.d(e,"ConstraintCoordinateSystem",function(){return a}),n.d(e,"FabrikJoint2D",function(){return h}),n.d(e,"FabrikJoint3D",function(){return d}),n.d(e,"FabrikBone2D",function(){return _}),n.d(e,"FabrikBone3D",function(){return f}),n.d(e,"FabrikChain2D",function(){return m}),n.d(e,"FabrikChain3D",function(){return L}),n.d(e,"FabrikStructure2D",function(){return y}),n.d(e,"FabrikStructure3D",function(){return C}),n.d(e,"Vec3f",function(){return l}),n.d(e,"Mat3f",function(){return g}),n.d(e,"Mat4f",function(){return A}),n.d(e,"Vec2f",function(){return p}),n.d(e,"Utils",function(){return u}),n.d(e,"Colour4f",function(){return c}),n.d(e,"Scene",function(){return P})}]);